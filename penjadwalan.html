<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Penjadwalan ‚Äî Inspeksi & Service</title>

  <!-- gunakan stylesheet utama -->
  <link rel="stylesheet" href="styles.css">

  <!-- jsPDF untuk export PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <!-- SIDEBAR (sama struktur seperti halaman lain) -->
  <div class="sidebar" id="sidebar">
    <button class="toggle-btn" onclick="toggleSidebar()">‚ò∞</button>

    <!-- brand -->
    <div class="brand" style="padding:0 18px 12px 18px;">
      <h2>PT. UNITED TRACTORS</h2>
      <h3>SEMEN GRESIK</h3>
    </div>

    <h2 style="text-align:center;margin:0 0 8px 0;font-size:14px;color:#000;">MENU</h2>

    <div class="menu-item" onclick="location.href='index.html'">üìä <span class="menu-text">Dashboard</span></div>
    <div class="menu-item" onclick="location.href='form.html'">üìù <span class="menu-text">Form</span></div>
    <div class="menu-item" onclick="location.href='history.html'">üìö <span class="menu-text">Histori</span></div>
    <div class="menu-item active" onclick="location.href='penjadwalan.html'">üìÖ <span class="menu-text">Penjadwalan</span></div>
  </div>

  <!-- CONTENT -->
  <div class="content">
    <div class="page-header">
      <h1>Penjadwalan</h1>
      <div class="small">Input Jadwal Service / Inspection ‚Äî simpan otomatis ke Google Sheets</div>
    </div>

    <div class="form-container" style="margin-bottom:18px;">
      <div class="form-header">Input Jadwal Service / Inspection</div>

      <form id="scheduleForm">
        <div class="grid-3" style="gap:12px;">
          <label>
            Type
            <select id="s_type" required>
              <option value="service">Service</option>
              <option value="inspection" selected>Inspection</option>
              <option value="both">Service & Inspection</option>
            </select>
          </label>

          <label>
            Date of Inspection/Service
            <input id="s_date" type="date" required>
          </label>

          <label>
            Unit
            <select id="s_unit" required>
              <option value="">Pilih unit...</option>
              <option>EX</option><option>WL</option><option>GR</option><option>DT</option><option>DZ</option>
            </select>
          </label>

          <label>
            Code Unit
            <input id="s_code" type="text" placeholder="mis: DT-219">
          </label>

          <label>
            Hour Meter
            <input id="s_hm" type="number" min="0" placeholder="HM">
          </label>

          <label id="labelServiceType">
            Type Service
            <select id="s_servicetype">
              <option value="">Pilih...</option>
              <option>250</option><option>500</option><option>1000</option><option>2000</option>
            </select>
          </label>

          <label style="grid-column: span 3;">
            Keterangan Tambahan
            <textarea id="s_notes" rows="2" placeholder="Isi keterangan (spare part yang harus diganti, catatan khusus)"></textarea>
          </label>
        </div>

        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px;">
          <button type="reset" class="btn secondary">Reset</button>
          <button type="submit" class="btn-submit">Simpan Jadwal</button>
        </div>
      </form>
    </div>

    <!-- DRAFT JADWAL -->
    <div class="form-container">
      <div class="form-header">Draft Jadwal</div>

      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:8px;">
        <div class="small">Daftar jadwal yang tersimpan (data diambil dari Google Sheet)</div>
        <div>
          <button id="refreshBtn" class="btn">Refresh</button>
          <button id="downloadAllPdf" class="btn">Download Semua PDF</button>
        </div>
      </div>

      <div class="table-container">
        <table id="draftTable">
          <thead>
            <tr>
              <th>Date</th><th>Type</th><th>Unit</th><th>Code</th><th>HM</th><th>Type Service</th><th>Notes</th><th>Aksi</th>
            </tr>
          </thead>
          <tbody>
            <!-- rows injected by JS -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal preview jika perlu -->
  <div id="previewModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <button class="close-btn" onclick="closePreview()">&times;</button>
      <div id="previewBody"></div>
    </div>
  </div>

  <!-- SCRIPT -->
  <script>
  // ================== SESUAIKAN API_URL ==================
  const API_URL = "https://script.google.com/macros/s/AKfycbyrmgMSm52XT6oPNHbdLl8xkspCF1ob2LA9w0Uo6Qk_tQpPqne6KY5cYcqrtMjorPpl2w/exec";
  // ======================================================

  // util: toggle sidebar
  function toggleSidebar(){
    const sb = document.getElementById('sidebar');
    sb.classList.toggle('closed');
  }

  // show/hide type service sesuai pilihan type
  function updateServiceTypeVisibility(){
    const type = document.getElementById('s_type').value;
    const label = document.getElementById('labelServiceType');
    const sel = document.getElementById('s_servicetype');
    if(type === 'inspection'){
      label.style.display = 'none';
      sel.value = '';
      sel.disabled = true;
    } else {
      label.style.display = 'block';
      sel.disabled = false;
    }
  }

  // initialize defaults
  document.addEventListener('DOMContentLoaded', function(){
    // set today's date as default
    const today = new Date().toISOString().slice(0,10);
    document.getElementById('s_date').value = today;

    // listen type change
    document.getElementById('s_type').addEventListener('change', updateServiceTypeVisibility);
    updateServiceTypeVisibility();

    // form submit
    document.getElementById('scheduleForm').addEventListener('submit', async function(e){
      e.preventDefault();
      await saveSchedule();
    });

    document.getElementById('refreshBtn').addEventListener('click', loadDrafts);
    document.getElementById('downloadAllPdf').addEventListener('click', downloadAllPdf);

    // load initial drafts
    loadDrafts();
  });

  // save to Apps Script (POST)
  async function saveSchedule(){
    if(!API_URL || API_URL === 'PASTE_API_URL_KAMU_HERE'){
      alert('ERROR: Ganti API_URL di file ini dengan Web App URL dari Apps Script Anda.');
      return;
    }

    const payload = {
      date: document.getElementById('s_date').value,
      type: document.getElementById('s_type').value,
      unit: document.getElementById('s_unit').value,
      code_unit: document.getElementById('s_code').value,
      hour_meter: document.getElementById('s_hm').value,
      type_service: document.getElementById('s_servicetype').value,
      notes: document.getElementById('s_notes').value
    };

    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const j = await res.json();
      console.log('POST response:', j);
      if(j && (j.status === 'success' || j === 'OK' || j.result === 'success')){
        alert('Jadwal berhasil disimpan ke Google Sheets.');
        // refresh table
        loadDrafts();
        document.getElementById('scheduleForm').reset();
        // restore defaults
        document.getElementById('s_date').value = new Date().toISOString().slice(0,10);
        updateServiceTypeVisibility();
      } else {
        alert('Respon server: ' + JSON.stringify(j));
        console.warn('Unexpected POST response', j);
      }
    } catch (err){
      console.error('Error POST:', err);
      alert('Gagal menyimpan jadwal. Cek console untuk detail.');
    }
  }

  // load drafts via GET (tolerant terhadap format response)
  async function loadDrafts(){
    if(!API_URL || API_URL === 'PASTE_API_URL_KAMU_HERE'){
      const tbody = document.querySelector('#draftTable tbody');
      tbody.innerHTML = '<tr><td colspan="8" class="small">API URL belum diatur. Silakan konfig Apps Script Web App lalu ganti API_URL.</td></tr>';
      return;
    }

    try {
      const res = await fetch(API_URL);
      const data = await res.json();
      console.log('GET response raw:', data);

      // handle two possible formats:
      // - array of objects [{date,type,unit,...}, ...]
      // - array of rows [[header1,header2...],[row1col1,row1col2...],...]
      let items = [];

      if(Array.isArray(data) && data.length > 0 && typeof data[0] === 'object' && !Array.isArray(data[0])){
        // already array of objects
        items = data;
      } else if(Array.isArray(data) && data.length > 1 && Array.isArray(data[0])){
        // first row may be header; convert rows starting at index 1
        // expected order: timestamp, date, type, unit, code_unit, hour_meter, type_service, notes, technician (some scripts may include fewer cols)
        const rows = data;
        const headerRow = rows[0].map(h => String(h).toLowerCase());
        const start = 1;
        for(let i = start; i < rows.length; i++){
          const r = rows[i];
          items.push({
            timestamp: r[0],
            date: r[1],
            type: r[2],
            unit: r[3],
            code_unit: r[4],
            hour_meter: r[5],
            type_service: r[6],
            notes: r[7],
            technician: r[8]
          });
        }
      } else {
        items = [];
      }

      renderDraftTable(items);
    } catch(err){
      console.error('Error GET:', err);
      const tbody = document.querySelector('#draftTable tbody');
      tbody.innerHTML = '<tr><td colspan="8" class="small">Gagal memuat data. Cek koneksi atau API URL.</td></tr>';
    }
  }

  // render table
  function renderDraftTable(items){
    const tbody = document.querySelector('#draftTable tbody');
    tbody.innerHTML = '';
    if(!items || items.length === 0){
      tbody.innerHTML = '<tr><td colspan="8" class="small">Belum ada draft jadwal.</td></tr>';
      window.__draft_items = [];
      return;
    }

    items.forEach((it, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(it.date||'')}</td>
        <td>${escapeHtml(it.type||'')}</td>
        <td>${escapeHtml(it.unit||'')}</td>
        <td>${escapeHtml(it.code_unit||it.code||'')}</td>
        <td>${escapeHtml(it.hour_meter||it.hm||'')}</td>
        <td>${escapeHtml(it.type_service||'')}</td>
        <td>${escapeHtml(it.notes||'')}</td>
        <td style="white-space:nowrap">
          <button class="btn" onclick='downloadPdf(${idx})'>PDF</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    // store current items for PDF download
    window.__draft_items = items;
  }

  // download single PDF by index (uses jsPDF)
  async function downloadPdf(index){
    const items = window.__draft_items || [];
    const item = items[index];
    if(!item){ alert('Data tidak ditemukan.'); return; }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(14);
    doc.text('Jadwal Service / Inspection', 14, 20);
    doc.setFontSize(11);
    doc.text(`Date: ${item.date || '-'}`, 14, 34);
    doc.text(`Type: ${item.type || '-'}`, 14, 42);
    doc.text(`Unit: ${item.unit || '-'}  Code: ${item.code_unit || item.code || '-'}`, 14, 50);
    doc.text(`Hour Meter: ${item.hour_meter || item.hm || '-'}`, 14, 58);
    doc.text(`Type Service: ${item.type_service || '-'}`, 14, 66);
    doc.text('Keterangan:', 14, 78);
    // wrap notes
    const notes = (item.notes || '-').toString();
    const split = doc.splitTextToSize(notes, 180);
    doc.text(split, 14, 86);
    const ts = item.timestamp ? String(item.timestamp).replace(/[: ]/g,'_') : Date.now();
    doc.save(`jadwal-${ts}.pdf`);
  }

  // download all drafts as separate PDFs in sequence
  async function downloadAllPdf(){
    const items = window.__draft_items || [];
    if(!items.length){ alert('Tidak ada data.'); return; }
    for(let i=0;i<items.length;i++){
      // small delay to avoid blocking
      await new Promise(r=>setTimeout(r,150));
      await downloadPdf(i);
    }
  }

  // simple escape
  function escapeHtml(s){
    if(!s) return '';
    return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]); });
  }

  // modal helpers (optional)
  function closePreview(){ document.getElementById('previewModal').classList.remove('open'); }
  function openPreview(html){ document.getElementById('previewBody').innerHTML = html; document.getElementById('previewModal').classList.add('open'); }
  </script>
</body>
</html>
